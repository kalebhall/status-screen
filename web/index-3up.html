<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0" />
  <title>Status Display (3 Person)</title>
  <style>
    :root {
      color-scheme: only light;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ffffff;
      color: #000000;
      overflow: hidden;
    }
    .screen {
      width: 1920px;
      height: 1080px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 60px 80px 90px;
      box-sizing: border-box;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      border: 6px solid #000000;
      padding: 36px 48px;
      min-height: 260px;
      gap: 40px;
    }
    .name {
      font-size: 96px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 16px;
    }
    .detail {
      font-size: 54px;
      opacity: 0.9;
    }
    .meta {
      font-size: 48px;
      opacity: 0.85;
      margin-top: 16px;
    }
    .status-tag {
      font-size: 64px;
      font-weight: 700;
      padding: 18px 36px;
      border: 6px solid #000000;
      text-transform: uppercase;
      text-align: center;
      min-width: 320px;
    }
    .status-available {
      background: #ffffff;
      color: #000000;
    }
    .status-busy,
    .status-meeting,
    .status-ooo,
    .status-error {
      background: #d0021b;
      color: #ffffff;
    }
    .footer {
      position: absolute;
      bottom: 30px;
      right: 60px;
      font-size: 44px;
    }
  </style>
</head>
<body>
  <div class="screen">
    <div class="row">
      <div>
        <div class="name" id="name-0">Person 1</div>
        <div class="detail" id="detail-0"></div>
        <div class="meta" id="meta-0"></div>
      </div>
      <div class="status-tag status-available" id="status-0">AVAILABLE</div>
    </div>
    <div class="row">
      <div>
        <div class="name" id="name-1">Person 2</div>
        <div class="detail" id="detail-1"></div>
        <div class="meta" id="meta-1"></div>
      </div>
      <div class="status-tag status-available" id="status-1">AVAILABLE</div>
    </div>
    <div class="row">
      <div>
        <div class="name" id="name-2">Person 3</div>
        <div class="detail" id="detail-2"></div>
        <div class="meta" id="meta-2"></div>
      </div>
      <div class="status-tag status-available" id="status-2">AVAILABLE</div>
    </div>
  </div>
  <div class="footer" id="footer"></div>

  <script>
    const footer = document.getElementById("footer");
    const rows = [0, 1, 2].map((index) => ({
      name: document.getElementById(`name-${index}`),
      detail: document.getElementById(`detail-${index}`),
      meta: document.getElementById(`meta-${index}`),
      status: document.getElementById(`status-${index}`),
    }));

    function formatTime(date, timeZone) {
      const baseOptions = {
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      };
      if (timeZone) {
        try {
          return date.toLocaleTimeString("en-US", {
            ...baseOptions,
            timeZone,
          });
        } catch (error) {
          return date.toLocaleTimeString("en-US", baseOptions);
        }
      }
      return date.toLocaleTimeString("en-US", baseOptions);
    }

    function formatDate(date, timeZone) {
      const baseOptions = {
        month: "2-digit",
        day: "2-digit",
        year: "numeric",
      };
      if (timeZone) {
        try {
          return date.toLocaleDateString("en-US", {
            ...baseOptions,
            timeZone,
          });
        } catch (error) {
          return date.toLocaleDateString("en-US", baseOptions);
        }
      }
      return date.toLocaleDateString("en-US", baseOptions);
    }

    function getZonedParts(date, timeZone) {
      if (timeZone) {
        try {
          const parts = new Intl.DateTimeFormat("en-US", {
            timeZone,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          }).formatToParts(date);
          const lookup = Object.fromEntries(parts.map((part) => [part.type, part.value]));
          return {
            year: Number.parseInt(lookup.year, 10),
            month: Number.parseInt(lookup.month, 10) - 1,
            day: Number.parseInt(lookup.day, 10),
            hour: Number.parseInt(lookup.hour, 10),
            minute: Number.parseInt(lookup.minute, 10),
          };
        } catch (error) {
          // Fall through to local time
        }
      }
      return {
        year: date.getFullYear(),
        month: date.getMonth(),
        day: date.getDate(),
        hour: date.getHours(),
        minute: date.getMinutes(),
      };
    }

    function isSameDay(first, second, timeZone) {
      const firstParts = getZonedParts(first, timeZone);
      const secondParts = getZonedParts(second, timeZone);
      return (
        firstParts.year === secondParts.year &&
        firstParts.month === secondParts.month &&
        firstParts.day === secondParts.day
      );
    }

    function isWithinWorkHours(date, timeZone) {
      const WORKDAY_START = 9;
      const WORKDAY_END = 17;
      const parts = getZonedParts(date, timeZone);
      return parts.hour >= WORKDAY_START && parts.hour < WORKDAY_END;
    }

    function shouldShowNextEvent(nextEventAt) {
      if (!nextEventAt) {
        return false;
      }
      const nextTime = new Date(nextEventAt);
      if (Number.isNaN(nextTime.getTime())) {
        return false;
      }
      const now = new Date();
      if (nextTime <= now) {
        return false;
      }
      if (!isSameDay(nextTime, now)) {
        return false;
      }
      return isWithinWorkHours(nextTime);
    }

    function setRow(index, person) {
      if (!rows[index]) {
        return;
      }
      const state = person.state || "error";
      rows[index].name.textContent = person.name || `Person ${index + 1}`;
      rows[index].detail.textContent = person.detail || "";
      rows[index].meta.textContent = shouldShowNextEvent(person.next_event_at)
        ? `Next event at ${formatTime(new Date(person.next_event_at))}`
        : "";
      rows[index].status.textContent = person.label || state.toUpperCase();
      rows[index].status.className = `status-tag status-${state}`;
    }

    function updateClock() {
      const now = new Date();
      footer.textContent = `${formatDate(now)} ${formatTime(now)}`;
    }

    async function loadStatus() {
      try {
        const r = await fetch("/status-multi.json?cache=" + Date.now());
        const data = await r.json();
        const people = data.people || [];
        rows.forEach((_, index) => {
          setRow(index, people[index] || { name: `Person ${index + 1}`, state: "error", label: "NO DATA" });
        });
      } catch (error) {
        rows.forEach((_, index) => {
          setRow(index, { name: `Person ${index + 1}`, state: "error", label: "STATUS ERROR" });
        });
      }
    }

    setInterval(updateClock, 1000);
    setInterval(loadStatus, 5000);
    updateClock();
    loadStatus();
  </script>
</body>
</html>
